{% extends "base.html" %}

{% block title %}Prediction Result - Ziber Autohub{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto mt-10">
  <div id="chat-box" class="border rounded p-4 h-96 overflow-y-auto bg-gray-100">
  </div>
  <form id="chat-form" class="mt-4 flex">
    <input type="text" id="user-input" class="flex-1 border rounded-l p-2" placeholder="Type something..." autocomplete="off">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r">Send</button>
  </form>
</div>

<script>
  let step = 0;
  let selectedCar = null;
  let serviceOptions = JSON.parse('{{ car_service_options|safe }}');
  let eligibleCars = {{ eligible_cars|safe }};

  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const userInput = document.getElementById("user-input");

  function addMessage(sender, text) {
    const msg = document.createElement("div");
    msg.className = sender === "bot" ? "text-left mb-2" : "text-right mb-2";
    msg.innerHTML = `<span class="inline-block px-3 py-2 rounded ${sender === "bot" ? "bg-white" : "bg-blue-500 text-white"}">${text}</span>`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function botAsk(text) {
    setTimeout(() => addMessage("bot", text), 500);
  }

  chatForm.onsubmit = function (e) {
    e.preventDefault();
    const input = userInput.value.trim();
    if (!input) return;

    addMessage("user", input);

    if (step === 0) {
      const car = eligibleCars.find(c => c.name.toLowerCase() === input.toLowerCase());
      if (car) {
        selectedCar = car;
        step = 1;
        botAsk(`Available service for ${car.name} is: ${serviceOptions[car.id].join(', ')}`);
        botAsk("Please type the service type (e.g., 1st, 2nd):");
      } else {
        botAsk("Car not found. Please enter a valid car name.");
      }
    } else if (step === 1) {
      const allowed = serviceOptions[selectedCar.id];
      if (allowed.includes(input)) {
        step = 2;
        chatForm.dataset.serviceType = input;
        botAsk("Got it! Please briefly describe the issue or your request:");
      } else {
        botAsk("Invalid service type. Please type a valid next service (e.g., 1st, 2nd).");
      }
    } else if (step === 2) {
      const description = input;
      fetch("{% url 'hub:book_service_api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          car_id: selectedCar.id,
          service_type: chatForm.dataset.serviceType,
          description: description
        })
      }).then(res => res.json())
        .then(data => {
          if (data.success) {
            botAsk("‚úÖ Service booked successfully!");
          } else {
            botAsk("‚ùå " + data.message);
          }
        });
      step = 0;
      selectedCar = null;
    }

    userInput.value = "";
  };

  botAsk("üëã Hi! Please enter your car name to book a service.");
</script>

{% endblock %}